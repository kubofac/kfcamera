<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>é‡£æœè¨˜éŒ²ãƒ—ãƒ­ï¼šå¾®èª¿æ•´ãƒ»ãƒªã‚»ãƒƒãƒˆå¯¾å¿œ</title>
    <style>
        :root { --bg: #000; --accent: #00ff00; --btn: #007bff; --save: #28a745; --danger: #dc3545; }
        body, html { margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; }
        
        #viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #canvas { display: none; touch-action: none; }

        #info-overlay { position: absolute; top: 15px; right: 15px; pointer-events: none; }
        .size-badge { background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 12px; border: 2px solid var(--accent); color: var(--accent); font-size: 28px; font-weight: bold; }

        .controls { background: #1a1a1a; display: flex; justify-content: center; gap: 8px; padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); flex-wrap: wrap; }
        button { padding: 12px 18px; font-size: 14px; border-radius: 8px; border: none; background: var(--btn); color: white; font-weight: bold; cursor: pointer; }
        #save-panel-btn { background: var(--save); }
        #setup-btn { background: #6f42c1; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal-content { background: #222; padding: 25px; border-radius: 15px; border: 1px solid #444; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; font-size: 16px; }
        
        .album-item { border-bottom: 1px solid #333; padding: 15px 0; display: flex; gap: 12px; align-items: flex-start; }
        .album-item img { width: 110px; height: 110px; object-fit: cover; border-radius: 6px; }
        .album-data { flex: 1; font-size: 12px; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="info-overlay"><div id="size-display" class="size-badge">0.0 cm</div></div>
    </div>

    <div class="controls">
        <button id="setup-btn">è¨­å®š</button>
        <button id="camera-btn">ã‚«ãƒ¡ãƒ©</button>
        <button id="capture-btn">æ’®å½±</button>
        <button id="save-panel-btn" style="display:none;">è¨˜éŒ²</button>
        <button id="reset-btn">æ¶ˆå»</button>
        <button id="album-btn">å±¥æ­´</button>
    </div>

    <div id="setup-modal" class="modal">
        <div class="modal-content">
            <h3>ãƒ¡ã‚¸ãƒ£ãƒ¼å€ç‡ã®è¨­å®š</h3>
            <p style="font-size:12px;">åŸºæº–ç‰©ã®é•·ã•ã‚’å…¥åŠ›ã—ã€ç«¯ã‹ã‚‰ç«¯ã¾ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="number" id="base-length" value="10">
            <button id="setup-confirm" style="width:100%; padding:15px; background:var(--save);">ã“ã®è·é›¢ã§å›ºå®š</button>
            <button id="setup-reset-btn" style="width:100%; margin-top:10px; background:var(--danger);">å€ç‡ã‚’åˆæœŸåŒ–</button>
            <button onclick="document.getElementById('setup-modal').style.display='none'" style="margin-top:10px; width:100%; background:#444;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h3>é‡£æœã®è¨˜éŒ²</h3>
            <input type="text" id="fish-type" placeholder="é­šç¨®">
            <textarea id="memo" placeholder="å‚™è€ƒ" rows="3"></textarea>
            <div style="display: flex; gap: 10px;">
                <button id="final-save-btn" style="flex:1; background:var(--save);">ä¿å­˜</button>
                <button id="download-btn" style="flex:1; background:#fd7e14;">ç”»åƒ</button>
            </div>
            <button onclick="document.getElementById('save-modal').style.display='none'" style="margin-top:10px; width:100%; background:#444;">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="album-view" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>é‡£æœå±¥æ­´</h2>
            <button id="clear-all-btn" style="background:var(--danger); font-size:12px;">å…¨æ¶ˆå»</button>
        </div>
        <div id="album-list"></div>
        <button onclick="document.getElementById('album-view').style.display='none'" style="margin-top:20px; padding:15px; background:#444;">æˆ»ã‚‹</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const sizeDisplay = document.getElementById('size-display');
        let points = [], currentImage = null, ratio = 0.15;
        let isDragging = false, dragPointIndex = -1;
        let currentAddr = "ä¸æ˜", tideData = "";

        // --- æ½®æ±ãƒ»ä½ç½®æƒ…å ± (å¤‰æ›´ãªã—) ---
        function getTideInfo() {
            const now = new Date();
            const baseDate = new Date(2026, 0, 19);
            const moonAge = ((now - baseDate) / (1000*60*60*24)) % 29.53;
            let name = "ä¸­æ½®";
            if (moonAge < 2 || moonAge >= 28 || (moonAge >= 14 && moonAge < 16)) name = "å¤§æ½®";
            else if (moonAge < 6 || (moonAge >= 11 && moonAge < 14) || (moonAge >= 16 && moonAge < 20) || moonAge >= 25) name = "ä¸­æ½®";
            else if (moonAge < 9 || (moonAge >= 21 && moonAge < 24)) name = "å°æ½®";
            else if (moonAge < 10 || moonAge >= 24) name = "é•·æ½®";
            else name = "è‹¥æ½®";

            const hours = now.getHours() + (now.getMinutes()/60);
            const phase = Math.sin((hours/12.4) * Math.PI * 2);
            const isRising = Math.sin(((hours+0.1)/12.4) * Math.PI * 2) > phase;
            const p = Math.abs(Math.round(phase * 10));
            return `${name} (${isRising ? 'ä¸Šã’' : 'ä¸‹ã’'}${p === 0 ? 'æ­¢ã¾ã‚Š' : p + 'åˆ†'})`;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                const data = await res.json();
                currentAddr = data.address.city || data.address.town || "ä¸æ˜";
            } catch(e) {}
        });

        // --- ã‚«ãƒ¡ãƒ©ãƒ»æ’®å½± ---
        document.getElementById('camera-btn').addEventListener('click', async () => {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = s; video.style.display = 'block'; canvas.style.display = 'none';
            document.getElementById('save-panel-btn').style.display = 'none';
        });

        document.getElementById('capture-btn').addEventListener('click', () => {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0); currentImage = canvas.toDataURL('image/jpeg');
            video.style.display = 'none'; canvas.style.display = 'block';
            document.getElementById('save-panel-btn').style.display = 'inline-block';
            tideData = getTideInfo();
        });

        // --- ãƒ‰ãƒ©ãƒƒã‚°å¾®èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯ ---
        function getXY(e) {
            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width, sy = canvas.height / r.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - r.left) * sx, y: (clientY - r.top) * sy };
        }

        canvas.addEventListener('pointerdown', (e) => {
            if(!currentImage && document.getElementById('setup-modal').style.display !== 'flex') return;
            const pos = getXY(e);
            
            // æ—¢å­˜ã®ç‚¹ã«è¿‘ã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¾®èª¿æ•´ãƒ¢ãƒ¼ãƒ‰ï¼‰
            dragPointIndex = points.findIndex(p => Math.hypot(p.x - pos.x, p.y - pos.y) < 40);
            
            if (dragPointIndex === -1) {
                if (points.length >= 2) points = [];
                points.push(pos);
                dragPointIndex = points.length - 1;
            }
            isDragging = true;
            canvas.setPointerCapture(e.pointerId);
        });

        canvas.addEventListener('pointermove', (e) => {
            if (!isDragging || dragPointIndex === -1) return;
            points[dragPointIndex] = getXY(e);
            draw();
        });

        canvas.addEventListener('pointerup', () => {
            isDragging = false;
            dragPointIndex = -1;
        });

        function draw() {
            if(!currentImage) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
            const img = new Image(); img.src = currentImage;
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                points.forEach((p, i) => {
                    ctx.fillStyle = (i === dragPointIndex) ? 'yellow' : 'red';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI*2); ctx.fill();
                });
                if(points.length === 2){
                    ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 8; ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y); ctx.stroke();
                    sizeDisplay.innerText = (Math.hypot(points[1].x-points[0].x, points[1].y-points[0].y)*ratio).toFixed(1) + " cm";
                }
            };
        }

        // --- è¨­å®šãƒªã‚»ãƒƒãƒˆ ---
        document.getElementById('setup-btn').addEventListener('click', () => {
            document.getElementById('setup-modal').style.display = 'flex';
        });
        document.getElementById('setup-confirm').addEventListener('click', () => {
            if(points.length === 2){
                ratio = parseFloat(document.getElementById('base-length').value) / Math.hypot(points[1].x-points[0].x, points[1].y-points[0].y);
                alert("åŸºæº–ã‚’è¨­å®šã—ã¾ã—ãŸ"); document.getElementById('setup-modal').style.display='none';
                points = []; draw();
            } else { alert("2ç‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"); }
        });
        document.getElementById('setup-reset-btn').addEventListener('click', () => {
            ratio = 0.15;
            alert("å€ç‡ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
            document.getElementById('setup-modal').style.display='none';
        });

        // --- ä¿å­˜ãƒ»å±¥æ­´ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        document.getElementById('save-panel-btn').addEventListener('click', () => document.getElementById('save-modal').style.display = 'flex');
        document.getElementById('final-save-btn').addEventListener('click', () => {
            const item = { id: Date.now(), img: canvas.toDataURL('image/jpeg'), size: sizeDisplay.innerText, fish: document.getElementById('fish-type').value || "ä¸æ˜", memo: document.getElementById('memo').value || "", tide: tideData, addr: currentAddr, date: new Date().toLocaleString() };
            const h = JSON.parse(localStorage.getItem('fish_v4') || '[]');
            h.unshift(item); localStorage.setItem('fish_v4', JSON.stringify(h));
            alert('ä¿å­˜ã—ã¾ã—ãŸ'); document.getElementById('save-modal').style.display = 'none';
        });
        document.getElementById('download-btn').addEventListener('click', () => {
            const a = document.createElement('a'); a.download = `fish_${Date.now()}.jpg`; a.href = canvas.toDataURL('image/jpeg'); a.click();
        });
        document.getElementById('album-btn').addEventListener('click', () => {
            const list = document.getElementById('album-list'); list.innerHTML = '';
            const h = JSON.parse(localStorage.getItem('fish_v4') || '[]');
            h.forEach(i => {
                const d = document.createElement('div'); d.className = 'album-item';
                d.innerHTML = `<img src="${i.img}"><div class="album-data"><b>${i.fish} (${i.size})</b><br>ğŸ“… ${i.date}<br>ğŸŒŠ ${i.tide}<br>ğŸ“ ${i.addr}<br>ğŸ“ ${i.memo}</div><button onclick="del(${i.id})" style="background:var(--danger); padding:5px;">Ã—</button>`;
                list.appendChild(d);
            });
            document.getElementById('album-view').style.display = 'flex';
        });
        window.del = (id) => { if(confirm('æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ let h = JSON.parse(localStorage.getItem('fish_v4')); h = h.filter(x => x.id !== id); localStorage.setItem('fish_v4', JSON.stringify(h)); document.getElementById('album-btn').click(); } };
        document.getElementById('reset-btn').addEventListener('click', () => { points = []; draw(); sizeDisplay.innerText = "0.0 cm"; });
        document.getElementById('clear-all-btn').addEventListener('click', () => { if(confirm('å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('fish_v4'); document.getElementById('album-view').style.display='none'; } });
    </script>
</body>
</html>
