<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>é‡£æœè¨˜éŒ²ãƒ—ãƒ­ï¼šå®Œå…¨ç‰ˆ</title>
    <style>
        :root { --bg: #000; --accent: #00ff00; --btn: #007bff; --save: #28a745; --danger: #dc3545; }
        body, html { margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; }
        
        /* ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ */
        #viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #canvas { display: none; touch-action: none; }

        /* è¨ˆæ¸¬æ•°å€¤è¡¨ç¤º */
        #info-overlay { position: absolute; top: 15px; right: 15px; pointer-events: none; }
        .size-badge { background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 12px; border: 2px solid var(--accent); color: var(--accent); font-size: 28px; font-weight: bold; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .controls { background: #1a1a1a; display: flex; justify-content: center; gap: 8px; padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); flex-wrap: wrap; }
        button { padding: 12px 18px; font-size: 14px; border-radius: 8px; border: none; background: var(--btn); color: white; font-weight: bold; cursor: pointer; }
        #save-panel-btn { background: var(--save); }
        #setup-btn { background: #6f42c1; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal-content { background: #222; padding: 25px; border-radius: 15px; border: 1px solid #444; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; font-size: 16px; }
        
        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .album-item { border-bottom: 1px solid #333; padding: 15px 0; display: flex; gap: 12px; align-items: flex-start; }
        .album-item img { width: 110px; height: 110px; object-fit: cover; border-radius: 6px; border: 1px solid #555; }
        .album-data { flex: 1; font-size: 12px; line-height: 1.4; }
        .album-data b { font-size: 16px; color: var(--accent); }

        @media (orientation: landscape) { .controls { padding: 5px; } button { padding: 8px 15px; font-size: 12px; } }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="info-overlay">
            <div id="size-display" class="size-badge">0.0 cm</div>
        </div>
    </div>

    <div class="controls">
        <button id="setup-btn">è¨­å®š</button>
        <button id="camera-btn">ã‚«ãƒ¡ãƒ©</button>
        <button id="capture-btn">æ’®å½±</button>
        <button id="save-panel-btn" style="display:none;">è¨˜éŒ²ã™ã‚‹</button>
        <button id="reset-btn">æ¶ˆå»</button>
        <button id="album-btn">å±¥æ­´</button>
    </div>

    <div id="setup-modal" class="modal">
        <div class="modal-content">
            <h3>åŸºæº–ã®é•·ã•ã‚’è¨­å®š</h3>
            <p style="font-size:13px; color:#ccc;">1. åŸºæº–ç‰©ï¼ˆ10å††ç‰ã‚„ã‚«ãƒ¼ãƒ‰ç­‰ï¼‰ã‚’æ¨ªã«ç½®ã„ã¦æ’®å½±<br>2. ãã®ç‰©ã®é•·ã•ã‚’å…¥åŠ›ã—ã€ä¸¡ç«¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
            <input type="number" id="base-length" value="10" placeholder="åŸºæº–ã®é•·ã•(cm)">
            <button id="setup-confirm" style="width:100%; padding:15px; background:var(--save);">ã“ã®è·é›¢ã§è¨­å®š</button>
            <button onclick="document.getElementById('setup-modal').style.display='none'" style="margin-top:10px; width:100%; background:#444;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h3>é‡£æœã®è¨˜éŒ²</h3>
            <input type="text" id="fish-type" placeholder="é­šç¨®ï¼ˆä¾‹ï¼šã‚·ãƒ¼ãƒã‚¹ï¼‰">
            <textarea id="memo" placeholder="å‚™è€ƒãƒ»ãƒ«ã‚¢ãƒ¼ãªã©" rows="3"></textarea>
            <div style="display: flex; gap: 10px;">
                <button id="final-save-btn" style="flex:1; background:var(--save);">å±¥æ­´ã«ä¿å­˜</button>
                <button id="download-btn" style="flex:1; background:#fd7e14;">ç”»åƒä¿å­˜</button>
            </div>
            <button onclick="document.getElementById('save-modal').style.display='none'" style="margin-top:10px; width:100%; background:#444;">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="album-view" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>é‡£æœå±¥æ­´</h2>
            <button id="clear-all-btn" style="background:var(--danger); font-size:12px;">å…¨æ¶ˆå»</button>
        </div>
        <div id="album-list"></div>
        <button onclick="document.getElementById('album-view').style.display='none'" style="margin-top:20px; padding:15px; background:#444;">ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const sizeDisplay = document.getElementById('size-display');
        let points = [], currentImage = null, ratio = 0.15;
        let currentAddr = "å–å¾—ä¸­...", tideData = "";

        // --- æœˆé½¢ã‹ã‚‰æ½®å›ã‚Šã‚’è¨ˆç®— ---
        function getTideInfo() {
            const now = new Date();
            const baseDate = new Date(2026, 0, 19); // 2026å¹´ã®åŸºæº–æ–°æœˆ
            const moonAge = ((now - baseDate) / (1000*60*60*24)) % 29.53;
            let name = "ä¸­æ½®";
            if (moonAge < 2 || moonAge >= 28 || (moonAge >= 14 && moonAge < 16)) name = "å¤§æ½®";
            else if (moonAge < 6 || (moonAge >= 11 && moonAge < 14) || (moonAge >= 16 && moonAge < 20) || moonAge >= 25) name = "ä¸­æ½®";
            else if (moonAge < 9 || (moonAge >= 21 && moonAge < 24)) name = "å°æ½®";
            else if (moonAge < 10 || moonAge >= 24) name = "é•·æ½®";
            else name = "è‹¥æ½®";

            const hours = now.getHours() + (now.getMinutes()/60);
            const phase = Math.sin((hours/12.4) * Math.PI * 2);
            const isRising = Math.sin(((hours+0.1)/12.4) * Math.PI * 2) > phase;
            const p = Math.abs(Math.round(phase * 10));
            const bubun = (p === 0) ? "æ­¢ã¾ã‚Š" : p + "åˆ†";
            return `${name} (${isRising ? 'ä¸Šã’' : 'ä¸‹ã’'}${bubun})`;
        }

        // ä½ç½®æƒ…å ±
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                const data = await res.json();
                currentAddr = data.address.city || data.address.town || data.address.suburb || "ä¸æ˜";
            } catch(e) { currentAddr = "ä¸æ˜"; }
        });

        // ã‚«ãƒ¡ãƒ©
        document.getElementById('camera-btn').addEventListener('click', async () => {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = s; video.style.display = 'block'; canvas.style.display = 'none';
            document.getElementById('save-panel-btn').style.display = 'none';
        });

        // æ’®å½±
        document.getElementById('capture-btn').addEventListener('click', () => {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0); currentImage = canvas.toDataURL('image/jpeg');
            video.style.display = 'none'; canvas.style.display = 'block';
            document.getElementById('save-panel-btn').style.display = 'inline-block';
            tideData = getTideInfo(); // æ’®å½±æ™‚ã®æ½®æ±ã‚’å›ºå®š
        });

        // åˆæœŸè¨­å®š
        document.getElementById('setup-btn').addEventListener('click', () => {
            document.getElementById('setup-modal').style.display = 'flex';
        });
        document.getElementById('setup-confirm').addEventListener('click', () => {
            if(points.length === 2){
                const d = Math.sqrt(Math.pow(points[1].x-points[0].x,2)+Math.pow(points[1].y-points[0].y,2));
                ratio = parseFloat(document.getElementById('base-length').value) / d;
                alert("åŸºæº–ã‚’è¨­å®šã—ã¾ã—ãŸã€‚"); document.getElementById('setup-modal').style.display='none';
                points = []; draw();
            } else { alert("åŸºæº–ã®ä¸¡ç«¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"); }
        });

        // ã‚¿ãƒƒãƒ—è¨ˆæ¸¬
        canvas.addEventListener('pointerdown', (e) => {
            if(!currentImage && document.getElementById('setup-modal').style.display !== 'flex') return;
            const r = canvas.getBoundingClientRect();
            const sx = canvas.width/r.width, sy = canvas.height/r.height;
            if(points.length >= 2) points = [];
            points.push({ x: (e.clientX-r.left)*sx, y: (e.clientY-r.top)*sy });
            draw();
        });

        function draw() {
            if(!currentImage) ctx.clearRect(0,0,canvas.width,canvas.height);
            else { const img = new Image(); img.src = currentImage; img.onload = () => {
                ctx.drawImage(img, 0, 0);
                points.forEach(p => { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); });
                if(points.length === 2){
                    ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 8; ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y); ctx.stroke();
                    sizeDisplay.innerText = (Math.sqrt(Math.pow(points[1].x-points[0].x,2)+Math.pow(points[1].y-points[0].y,2))*ratio).toFixed(1) + " cm";
                }
            }; }
        }

        // ä¿å­˜ç³»
        document.getElementById('save-panel-btn').addEventListener('click', () => document.getElementById('save-modal').style.display = 'flex');
        
        document.getElementById('final-save-btn').addEventListener('click', () => {
            const item = { id: Date.now(), img: canvas.toDataURL('image/jpeg'), size: sizeDisplay.innerText, fish: document.getElementById('fish-type').value || "ä¸æ˜", memo: document.getElementById('memo').value || "", tide: tideData, addr: currentAddr, date: new Date().toLocaleString() };
            const h = JSON.parse(localStorage.getItem('fish_v3') || '[]');
            h.unshift(item); localStorage.setItem('fish_v3', JSON.stringify(h));
            alert('ä¿å­˜ã—ã¾ã—ãŸ'); document.getElementById('save-modal').style.display = 'none';
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            const a = document.createElement('a'); a.download = `fish_${Date.now()}.jpg`;
            a.href = canvas.toDataURL('image/jpeg'); a.click();
        });

        document.getElementById('album-btn').addEventListener('click', () => {
            const list = document.getElementById('album-list'); list.innerHTML = '';
            const h = JSON.parse(localStorage.getItem('fish_v3') || '[]');
            h.forEach(i => {
                const d = document.createElement('div'); d.className = 'album-item';
                d.innerHTML = `<img src="${i.img}"><div class="album-data"><b>${i.fish} (${i.size})</b><br>ğŸ“… ${i.date}<br>ğŸŒŠ ${i.tide}<br>ğŸ“ ${i.addr}<br>ğŸ“ ${i.memo}</div><button onclick="del(${i.id})" style="background:var(--danger); padding:5px;">Ã—</button>`;
                list.appendChild(d);
            });
            document.getElementById('album-view').style.display = 'flex';
        });

        window.del = (id) => { if(confirm('æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ let h = JSON.parse(localStorage.getItem('fish_v3')); h = h.filter(x => x.id !== id); localStorage.setItem('fish_v3', JSON.stringify(h)); document.getElementById('album-btn').click(); } };
        document.getElementById('reset-btn').addEventListener('click', () => { points = []; draw(); sizeDisplay.innerText = "0.0 cm"; });
        document.getElementById('clear-all-btn').addEventListener('click', () => { if(confirm('å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('fish_v3'); document.getElementById('album-view').style.display='none'; } });
    </script>
</body>
</html>
