<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>é‡£æœè¨˜éŒ²ãƒ—ãƒ­ï¼ˆä¿å­˜ãƒ»å‰Šé™¤å¯¾å¿œï¼‰</title>
    <style>
        :root { --bg: #000; --accent: #00ff00; --btn: #007bff; --danger: #dc3545; }
        body, html { margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; }
        
        #viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #canvas { display: none; touch-action: none; }

        #info-overlay { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; }
        .badge { background: rgba(0,0,0,0.7); padding: 5px 12px; border-radius: 8px; font-size: 12px; border: 1px solid #444; width: fit-content; }
        #size-display { color: var(--accent); font-size: 20px; font-weight: bold; }

        .controls { background: #1a1a1a; display: flex; justify-content: center; gap: 8px; padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); flex-wrap: wrap; }
        button { padding: 10px 18px; font-size: 14px; border-radius: 6px; border: none; background: var(--btn); color: white; font-weight: bold; cursor: pointer; }
        #save-btn { background: #28a745; }
        #download-btn { background: #fd7e14; }

        /* ã‚¢ãƒ«ãƒãƒ ç”»é¢ */
        #album-view { position: fixed; inset: 0; background: #111; z-index: 1000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .album-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .album-item { border-bottom: 1px solid #333; padding: 15px 0; display: flex; gap: 10px; align-items: center; }
        .album-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; }
        .del-btn { background: var(--danger); padding: 5px 10px; font-size: 12px; margin-left: auto; }
        
        @media (orientation: landscape) { .controls { padding: 5px; } button { padding: 5px 12px; font-size: 12px; } }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="info-overlay">
            <div id="addr-info" class="badge">ğŸ“ ä½æ‰€: å–å¾—ä¸­...</div>
            <div id="tide-info" class="badge">ğŸŒŠ æ½®æ±: è¨ˆç®—ä¸­...</div>
            <div id="size-display" class="badge">0.0 cm</div>
        </div>
    </div>

    <div class="controls">
        <button id="camera-btn">ã‚«ãƒ¡ãƒ©</button>
        <button id="capture-btn">æ’®å½±</button>
        <button id="download-btn" style="display:none;">æœ¬ä½“ä¿å­˜</button>
        <button id="save-btn" style="display:none;">å±¥æ­´ä¿å­˜</button>
        <button id="reset-btn">æ¶ˆå»</button>
        <button id="album-btn">å±¥æ­´</button>
    </div>

    <div id="album-view">
        <div class="album-header">
            <h2>é‡£æœå±¥æ­´</h2>
            <button id="clear-all-btn" style="background:var(--danger);">å…¨å‰Šé™¤</button>
        </div>
        <div id="album-list"></div>
        <button onclick="document.getElementById('album-view').style.display='none'" style="margin-top:20px; padding:15px; background:#444; width:100%;">é–‰ã˜ã‚‹</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let points = [], currentImage = null, currentAddr = "ä¸æ˜", tideStatus = "";

        // ä½ç½®æƒ…å ±å–å¾—
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18`);
                const data = await res.json();
                currentAddr = data.address.city || data.address.town || data.address.province || "ä¸æ˜";
                document.getElementById('addr-info').innerText = "ğŸ“ " + currentAddr;
            } catch (e) { }
        });

        // æ½®æ±è¨ˆç®—
        function calculateTide() {
            const now = new Date();
            const hours = now.getHours() + (now.getMinutes() / 60);
            const phase = Math.sin((hours / 12.4) * Math.PI * 2);
            const isRising = Math.sin(((hours + 0.1) / 12.4) * Math.PI * 2) > phase;
            const percentage = Math.abs(Math.round(phase * 10));
            tideStatus = `${isRising ? 'ä¸Šã’' : 'ä¸‹ã’'}${percentage === 0 ? 'æ­¢ã¾ã‚Š' : percentage + 'åˆ†'}`;
            document.getElementById('tide-info').innerText = `ğŸŒŠ ${tideStatus}`;
        }
        calculateTide();

        // ã‚«ãƒ¡ãƒ©ãƒ»æ’®å½±
        document.getElementById('camera-btn').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            video.style.display = 'block'; canvas.style.display = 'none';
            document.querySelectorAll('#save-btn, #download-btn').forEach(b => b.style.display = 'none');
        });

        document.getElementById('capture-btn').addEventListener('click', () => {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            currentImage = canvas.toDataURL('image/jpeg');
            video.style.display = 'none'; canvas.style.display = 'block';
            document.querySelectorAll('#save-btn, #download-btn').forEach(b => b.style.display = 'inline-block');
        });

        // è¨ˆæ¸¬æç”»
        canvas.addEventListener('pointerdown', (e) => {
            if (!currentImage) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width, scaleY = canvas.height / rect.height;
            if (points.length >= 2) points = [];
            points.push({ x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY });
            draw();
        });

        function draw() {
            const img = new Image(); img.src = currentImage;
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                points.forEach(p => { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); });
                if (points.length === 2) {
                    ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 8; ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y); ctx.stroke();
                    const dist = Math.sqrt(Math.pow(points[1].x-points[0].x,2) + Math.pow(points[1].y-points[0].y,2));
                    document.getElementById('size-display').innerText = (dist * 0.15).toFixed(1) + " cm";
                }
            };
        }

        // æœ¬ä½“ä¿å­˜
        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `fish_record_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg');
            link.click();
        });

        // å±¥æ­´ä¿å­˜
        document.getElementById('save-btn').addEventListener('click', () => {
            const data = { id: Date.now(), img: canvas.toDataURL('image/jpeg'), size: document.getElementById('size-display').innerText, tide: tideStatus, addr: currentAddr, date: new Date().toLocaleString() };
            const history = JSON.parse(localStorage.getItem('fishing_pro_v2') || '[]');
            history.unshift(data);
            localStorage.setItem('fishing_pro_v2', JSON.stringify(history));
            alert('å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ');
        });

        // ã‚¢ãƒ«ãƒãƒ è¡¨ç¤ºãƒ»å‰Šé™¤
        const renderAlbum = () => {
            const list = document.getElementById('album-list');
            list.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('fishing_pro_v2') || '[]');
            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'album-item';
                div.innerHTML = `<img src="${item.img}"><div style="font-size:11px"><p>ğŸ“… ${item.date}</p><p>ğŸ“ ${item.size} / ğŸŒŠ ${item.tide}</p><p>ğŸ“ ${item.addr}</p></div><button class="del-btn" onclick="deleteItem(${item.id})">å‰Šé™¤</button>`;
                list.appendChild(div);
            });
        };

        window.deleteItem = (id) => {
            if(!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            let history = JSON.parse(localStorage.getItem('fishing_pro_v2') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('fishing_pro_v2', JSON.stringify(history));
            renderAlbum();
        };

        document.getElementById('clear-all-btn').addEventListener('click', () => {
            if(!confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            localStorage.removeItem('fishing_pro_v2');
            renderAlbum();
        });

        document.getElementById('album-btn').addEventListener('click', () => {
            renderAlbum();
            document.getElementById('album-view').style.display = 'flex';
        });

        document.getElementById('reset-btn').addEventListener('click', () => { points = []; draw(); document.getElementById('size-display').innerText = "0.0 cm"; });
    </script>
</body>
</html>
