<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Log Pro Max - White Final</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        /* åŸºæœ¬è¨­å®šï¼šå¤œé‡£ã‚Šã§ã®ãƒ©ã‚¤ãƒˆä»£ã‚ã‚Šã«ãªã‚‹ç™½èƒŒæ™¯ */
        body { margin: 0; font-family: -apple-system, sans-serif; background: #ffffff; color: #1a1a1a; overflow: hidden; }
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* å…¥åŠ›ãƒ‘ãƒãƒ« */
        .input-panel { background: #f8f9fa; padding: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 20; border-bottom: 2px solid #dee2e6; }
        input[type="text"], textarea { 
            width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ced4da; 
            background: #ffffff; color: #000; font-size: 16px; outline: none; box-sizing: border-box;
        }
        textarea { height: 50px; font-size: 14px; resize: none; }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        #camera-container { position: relative; flex: 1; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* ãƒ¡ã‚¸ãƒ£ãƒ¼ï¼ˆRulerï¼‰ */
        #ruler {
            position: absolute; width: 200px; height: 60px; top: 50%; left: 50%;
            border: 2px solid #00b894; border-right: 4px solid #d63031;
            background: rgba(0, 184, 148, 0.15);
            background-image: linear-gradient(90deg, #00b894 2px, transparent 2px);
            background-size: 10% 40%; background-repeat: repeat-x; background-position: bottom;
            touch-action: none; cursor: move;
        }
        #size-label { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #d63031; color: white; padding: 4px 15px; border-radius: 15px; font-weight: bold; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* æ“ä½œUI */
        .controls { padding: 15px; display: flex; justify-content: space-around; background: #f1f3f5; border-top: 2px solid #dee2e6; z-index: 20; }
        button { padding: 12px 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        button:active { opacity: 0.7; }
        .btn-capture { background: #d63031; flex: 2; margin: 0 10px; font-size: 18px; }
        .btn-settings { background: #636e72; flex: 1; }
        .btn-album { background: #00b894; flex: 1; }

        /* ã‚¢ãƒ«ãƒãƒ ç”»é¢ */
        #album { display: none; position: fixed; inset: 0; background: #ffffff; padding: 15px; overflow-y: auto; z-index: 100; flex-direction: column; }
        .album-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .log-card { background: #ffffff; border-radius: 15px; overflow: hidden; border: 1px solid #dee2e6; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 500px; margin-inline: auto; }
        .card-image-container { position: relative; width: 100%; height: 200px; }
        .card-image-container img { width: 100%; height: 100%; object-fit: cover; }
        .fish-size-badge { position: absolute; top: 10px; right: 10px; background: #d63031; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .fish-name-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; padding: 25px 15px 10px; font-size: 20px; font-weight: bold; }
        
        .log-card-body { padding: 15px; }
        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 13px; color: #444; }
        .info-icon { min-width: 24px; }
        .tide-text { color: #0984e3; font-weight: bold; }
        .memo-container { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; border-left: 4px solid #00b894; border: 1px solid #eee; font-size: 13px; color: #555; }
        
        /* ä¿å­˜ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .btn-download { margin-top: 10px; background: #0984e3; width: 100%; padding: 10px; border-radius: 8px; font-size: 14px; }
        .btn-delete { background: transparent; color: #ff7675; border: 1px solid #fab1a0; padding: 8px; border-radius: 8px; margin-top: 10px; width: 100%; font-size: 12px; }

        /* è¨­å®šç”»é¢ */
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 200; align-items: center; justify-content: center; }
        .config-box { background: #fff; padding: 25px; border-radius: 20px; text-align: center; width: 85%; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="app">
    <div class="input-panel">
        <input type="text" id="fish-name" placeholder="é­šç¨® (ä¾‹: ã‚·ãƒ¼ãƒã‚¹)">
        <textarea id="fish-memo" placeholder="å‚™è€ƒ (ãƒã‚¤ãƒ³ãƒˆã®çŠ¶æ³ãªã©)"></textarea>
    </div>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="ruler" data-x="0" data-y="0">
            <div id="size-label">20.0 cm</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-settings" onclick="openSettings()">âš™ï¸è¨­å®š</button>
        <button class="btn-capture" onclick="captureFish()">è¨˜éŒ²ã™ã‚‹</button>
        <button class="btn-album" onclick="toggleAlbum()">ğŸ“¦ã‚¢ãƒ«ãƒãƒ </button>
    </div>
</div>

<div id="album">
    <div class="album-header">
        <h2 style="margin:0;">é‡£æœã‚¢ãƒ«ãƒãƒ </h2>
        <button onclick="toggleAlbum()" style="background:#636e72;">é–‰ã˜ã‚‹</button>
    </div>
    <div id="album-list"></div>
</div>

<div id="settings-modal">
    <div class="config-box">
        <h3>ğŸ“ ã‚µã‚¤ã‚ºæ ¡æ­£</h3>
        <p style="font-size:12px; color:#666; margin-bottom:20px;">ç·‘ã®æ ã‚’<b>10cm</b>ã«åˆã‚ã›ã¦ä¿å­˜ã—ã¦ãã ã•ã„</p>
        <button style="background:#00b894; width:100%; margin-bottom:10px; padding:15px;" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
        <button style="background:#ff7675; width:100%; font-size:12px; margin-bottom:15px; padding:10px;" onclick="resetSettings()">æ ¡æ­£ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button style="background:none; color:#999;" onclick="closeSettings()">æˆ»ã‚‹</button>
    </div>
</div>

<script>
    const db = new Dexie("FishingLogDB");
    db.version(3).stores({ logs: '++id, fishName, timestamp, location, address, tide, memo, size, photo' });

    let pxPerCm = localStorage.getItem('pxPerCm') || 20;
    let currentScale = 1;
    let currentRotation = 0;

    const video = document.getElementById('video');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => video.srcObject = s)
        .catch(e => alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"));

    // PCç”¨ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œ
    document.getElementById('ruler').addEventListener('wheel', e => {
        e.preventDefault();
        currentScale *= (e.deltaY > 0 ? 0.98 : 1.02);
        updateRuler(document.getElementById('ruler'));
    }, { passive: false });

    interact('#ruler').draggable({ onmove: e => {
        const t = e.target;
        const x = (parseFloat(t.getAttribute('data-x')) || 0) + e.dx;
        const y = (parseFloat(t.getAttribute('data-y')) || 0) + e.dy;
        updateRuler(t, x, y);
    }}).gesturable({ onmove: e => {
        currentScale *= (1 + e.ds); currentRotation += e.da; updateRuler(e.target);
    }});

    function updateRuler(t, x, y) {
        x = x !== undefined ? x : parseFloat(t.getAttribute('data-x'));
        y = y !== undefined ? y : parseFloat(t.getAttribute('data-y'));
        t.style.transform = `translate(${x}px, ${y}px) scale(${currentScale}) rotate(${currentRotation}deg)`;
        t.setAttribute('data-x', x); t.setAttribute('data-y', y);
        const cm = (200 * currentScale / pxPerCm).toFixed(1);
        document.getElementById('size-label').innerText = cm + " cm";
    }

    async function getAddress(lat, lon) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`);
            const data = await res.json();
            const a = data.address;
            const pref = a.province || a.prefecture || "";
            const city = a.city || a.town || a.village || a.city_district || "";
            const suburb = a.suburb || a.neighbourhood || a.quarter || "";
            const road = a.road || "";
            let addr = `${pref} ${city} ${suburb}`.trim();
            if (!suburb && road) addr += ` ${road}ä»˜è¿‘`;
            return addr || "ä½æ‰€ä¸æ˜";
        } catch { return "å–å¾—å¤±æ•—"; }
    }

    function getTideInfo() {
        const hours = new Date().getHours() + new Date().getMinutes() / 60;
        const cycle = (hours % 12.4) / 12.4;
        if (cycle < 0.06 || cycle >= 0.94) return "æº€æ½®ï¼ˆæ½®æ­¢ã¾ã‚Šï¼‰";
        if (cycle < 0.19) return "ä¸‹ã’ä¸‰åˆ†";
        if (cycle < 0.31) return "ä¸‹ã’äº”åˆ†";
        if (cycle < 0.44) return "ä¸‹ã’ä¸ƒåˆ†";
        if (cycle < 0.56) return "å¹²æ½®ï¼ˆæ½®æ­¢ã¾ã‚Šï¼‰";
        if (cycle < 0.69) return "ä¸Šã’ä¸‰åˆ†";
        if (cycle < 0.81) return "ä¸Šã’äº”åˆ†";
        return "ä¸Šã’ä¸ƒåˆ†";
    }

    window.openSettings = () => document.getElementById('settings-modal').style.display = 'flex';
    window.closeSettings = () => document.getElementById('settings-modal').style.display = 'none';
    window.saveSettings = () => {
        pxPerCm = (200 * currentScale) / 10;
        localStorage.setItem('pxPerCm', pxPerCm);
        alert("ä¿å­˜å®Œäº†");
        closeSettings();
    };
    window.resetSettings = () => {
        if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('pxPerCm'); location.reload(); }
    };

    window.captureFish = async function() {
        const name = document.getElementById('fish-name').value || "ä¸æ˜ãªé­š";
        const memo = document.getElementById('fish-memo').value || "";
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude; const lon = pos.coords.longitude;
            const address = await getAddress(lat, lon);
            const tide = getTideInfo();
            const cm = (200 * currentScale / pxPerCm).toFixed(1);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            await db.logs.add({
                fishName: name, timestamp: new Date().toLocaleString('ja-JP'),
                address: address, tide: tide, memo: memo, size: cm,
                photo: canvas.toDataURL('image/jpeg', 0.8)
            });
            alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            document.getElementById('fish-name').value = ""; document.getElementById('fish-memo').value = "";
        }, () => alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„"));
    };

    window.toggleAlbum = async function() {
        const el = document.getElementById('album');
        if (el.style.display === 'none' || !el.style.display) {
            await loadAlbum(); el.style.display = 'flex';
        } else { el.style.display = 'none'; }
    };

    async function loadAlbum() {
        const listEl = document.getElementById('album-list');
        const logs = await db.logs.toArray();
        if (logs.length === 0) { listEl.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>è¨˜éŒ²ãªã—</p>"; return; }
        listEl.innerHTML = logs.reverse().map(l => `
            <div class="log-card">
                <div class="card-image-container">
                    <img src="${l.photo}">
                    <div class="fish-size-badge">${l.size} cm</div>
                    <div class="fish-name-overlay">${l.fishName}</div>
                </div>
                <div class="log-card-body">
                    <div class="info-row"><span class="info-icon">ğŸ“…</span><span>${l.timestamp}</span></div>
                    <div class="info-row"><span class="info-icon">ğŸ“</span><span>${l.address}</span></div>
                    <div class="info-row"><span class="info-icon">ğŸŒŠ</span><span class="tide-text">${l.tide}</span></div>
                    ${l.memo ? `<div class="memo-container">${l.memo}</div>` : ''}
                    <button class="btn-download" onclick="downloadPhoto('${l.photo}', '${l.fishName}_${l.size}cm')">ğŸ“² ã‚¹ãƒãƒ›ã«ä¿å­˜</button>
                    <button class="btn-delete" onclick="deleteLog(${l.id})">å‰Šé™¤</button>
                </div>
            </div>`).join('');
    }

    window.downloadPhoto = (dataUrl, fileName) => {
        const a = document.createElement('a'); a.href = dataUrl; a.download = `${fileName}.jpg`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(() => alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ"), 100);
    };

    window.deleteLog = async (id) => {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { await db.logs.delete(id); loadAlbum(); }
    };
</script>
</body>

</html>
