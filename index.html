<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é‡£æœè¨˜éŒ²ï¼šã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ²å¯¾å¿œç‰ˆ</title>
    <style>
        :root { --bg: #000; --accent: #00ff00; --calib: #ffc107; --measure: #007bff; --save: #28a745; --danger: #dc3545; --quick: #6f42c1; }
        body, html { margin: 0; padding: 0; height: 100dvh; width: 100vw; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; touch-action: none; }
        
        #viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #canvas { display: none; }

        #mode-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px; font-size: 13px; border: 1px solid white; z-index: 10; }
        #info-overlay { position: absolute; top: 15px; right: 15px; pointer-events: none; z-index: 10; }
        .size-badge { background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 12px; border: 2px solid var(--accent); color: var(--accent); font-size: 28px; font-weight: bold; min-width: 100px; text-align: center; }

        .controls { background: #1a1a1a; display: flex; justify-content: center; gap: 5px; padding: 10px; flex-wrap: wrap; box-sizing: border-box; }
        button { padding: 12px 5px; font-size: 12px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; min-width: 70px; -webkit-tap-highlight-color: transparent; }
        
        #camera-btn { background: #444; }
        #capture-btn { background: #fff; color: #000; }
        #clear-btn { background: #555; }
        #quick-save-btn { background: var(--quick); display: none; } /* ã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ² */
        #calibrate-mode-btn { background: var(--calib); color: #000; display: none; }
        #measure-mode-btn { background: var(--measure); display: none; }
        #save-panel-btn { background: var(--save); display: none; border: 1px solid white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal-content { background: #222; padding: 20px; border-radius: 15px; border: 1px solid #444; margin-top: 20px; }
        input, textarea { width: 100%; padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }

        .album-item { display: flex; background: #1a1a1a; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; overflow: hidden; height: 120px; }
        .album-img { width: 120px; height: 120px; object-fit: cover; }
        .album-info { flex: 1; padding: 8px; font-size: 11px; display: flex; flex-direction: column; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="mode-label">1. ã€Œã‚«ãƒ¡ãƒ©ã€â†’ã€Œæ’®å½±ã€</div>
        <div id="info-overlay"><div id="size-display" class="size-badge">--- cm</div></div>
    </div>

    <div class="controls">
        <button id="camera-btn">ğŸ“·ã‚«ãƒ¡ãƒ©</button>
        <button id="capture-btn">ğŸ“¸æ’®å½±</button>
        <button id="clear-btn">ğŸ”„ã‚¯ãƒªã‚¢</button>
        <button id="quick-save-btn">ğŸ“0.ç™»éŒ²</button>
        <button id="calibrate-mode-btn">ğŸ“1.è£œæ­£</button>
        <button id="measure-mode-btn">ğŸŸ2.æ¸¬å®š</button>
        <button id="save-panel-btn">ğŸ“3.ç™»éŒ²</button>
        <button id="album-btn" style="background:#444;">å±¥æ­´</button>
    </div>

    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h3>é‡£æœã®ç™»éŒ²</h3>
            <div id="auto-data-display" style="background:#111; padding:10px; border-radius:8px; font-size:13px; margin-bottom:10px; color:var(--accent); white-space: pre-wrap;"></div>
            <input type="text" id="fish-type" placeholder="é­šç¨®ï¼ˆç©ºæ¬„ã§ã‚‚OKï¼‰">
            <textarea id="memo-field" rows="2" placeholder="å‚™è€ƒ"></textarea>
            <button id="final-save-btn" style="width:100%; padding:15px; background:var(--save); color:white; font-weight:bold; border-radius:8px;">ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜</button>
            <button id="close-save-btn" style="margin-top:10px; width:100%; background:#444; color:white; padding:10px; border:none; border-radius:8px;">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="calib-modal" class="modal" style="justify-content:center;">
        <div class="modal-content">
            <h3>åŸºæº–ã®é•·ã•(cm)</h3>
            <input type="number" id="real-length" value="10.0" step="0.1">
            <button id="calib-confirm" style="width:100%; padding:15px; background:var(--save); color:white; font-weight:bold; border-radius:8px;">OK</button>
        </div>
    </div>

    <div id="album-view" class="modal">
        <h2>é‡£æœå±¥æ­´</h2>
        <div id="album-list"></div>
        <button id="close-album-btn" style="padding:15px; background:#444; border:none; color:white; border-radius:8px; margin-top:10px; width:100%;">é–‰ã˜ã‚‹</button>
    </div>

    <script>
        const video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        const sizeDisplay = document.getElementById('size-display'), modeLabel = document.getElementById('mode-label');
        const savePanelBtn = document.getElementById('save-panel-btn'), quickSaveBtn = document.getElementById('quick-save-btn');
        let points = [], currentImageRaw = null, ratio = 1, mode = 'WAIT', isDragging = false, dragPointIndex = -1, autoAddr = "", autoTide = "";

        function getXY(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - r.left) * (canvas.width / r.width), y: (clientY - r.top) * (canvas.height / r.height) };
        }

        async function startCamera() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = s; video.style.display = 'block'; canvas.style.display = 'none';
                resetStates();
                modeLabel.innerText = "æ’®å½±ã—ã¦ãã ã•ã„";
            } catch (e) { alert("ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™"); }
        }
        document.getElementById('camera-btn').addEventListener('click', startCamera);

        function resetStates() {
            points = []; currentImageRaw = null; ratio = 1; mode = 'WAIT';
            sizeDisplay.innerText = "--- cm";
            document.getElementById('calibrate-mode-btn').style.display = 'none';
            document.getElementById('measure-mode-btn').style.display = 'none';
            savePanelBtn.style.display = 'none';
            quickSaveBtn.style.display = 'none';
        }

        document.getElementById('clear-btn').addEventListener('click', () => {
            resetStates(); video.style.display = 'block'; canvas.style.display = 'none';
            modeLabel.innerText = "ãƒªã‚»ãƒƒãƒˆå®Œäº†";
        });

        document.getElementById('capture-btn').addEventListener('click', () => {
            if(!video.videoWidth) return;
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0); currentImageRaw = canvas.toDataURL('image/jpeg');
            video.style.display = 'none'; canvas.style.display = 'block';
            
            // æ’®å½±ç›´å¾Œã«ã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ²ã¨è£œæ­£ãƒœã‚¿ãƒ³ã‚’ä¸¡æ–¹å‡ºã™
            quickSaveBtn.style.display = 'inline-block';
            document.getElementById('calibrate-mode-btn').style.display = 'inline-block';
            modeLabel.innerText = "0.ã§ã™ãç™»éŒ² ã‹ 1.ã§æ¸¬å®š";
            draw();
        });

        document.getElementById('calibrate-mode-btn').addEventListener('click', () => { 
            mode = 'CALIBRATE'; points = []; quickSaveBtn.style.display = 'none'; draw(); 
        });
        document.getElementById('measure-mode-btn').addEventListener('click', () => { mode = 'MEASURE'; points = []; draw(); });

        canvas.addEventListener('pointerdown', (e) => {
            if(mode === 'WAIT' || !currentImageRaw) return;
            const pos = getXY(e);
            dragPointIndex = points.findIndex(p => Math.hypot(p.x - pos.x, p.y - pos.y) < 60);
            if (dragPointIndex === -1 && points.length < 2) { points.push(pos); dragPointIndex = points.length - 1; }
            isDragging = true; canvas.setPointerCapture(e.pointerId); draw();
        });

        canvas.addEventListener('pointermove', (e) => { if (isDragging && dragPointIndex !== -1) { points[dragPointIndex] = getXY(e); draw(); } });
        canvas.addEventListener('pointerup', () => {
            isDragging = false;
            if (points.length === 2) {
                if (mode === 'CALIBRATE') document.getElementById('calib-modal').style.display = 'flex';
                else if (mode === 'MEASURE') { savePanelBtn.style.display = 'inline-block'; modeLabel.innerText = "æ¸¬å®šå®Œäº†"; }
            }
        });

        function draw() {
            const img = new Image(); img.src = currentImageRaw;
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                const color = (mode === 'CALIBRATE') ? '#ffc107' : '#00ff00';
                points.forEach(p => {
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(p.x, p.y, 15, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, 11, 0, Math.PI*2); ctx.fill();
                });
                if(points.length === 2){
                    ctx.strokeStyle = color; ctx.lineWidth = 6;
                    ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y); ctx.stroke();
                    if(mode === 'MEASURE') sizeDisplay.innerText = (Math.hypot(points[1].x-points[0].x, points[1].y-points[0].y)*ratio).toFixed(1) + " cm";
                }
            };
        }

        document.getElementById('calib-confirm').addEventListener('click', () => {
            ratio = parseFloat(document.getElementById('real-length').value) / Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
            document.getElementById('calib-modal').style.display = 'none';
            document.getElementById('measure-mode-btn').style.display = 'inline-block';
        });

        // å…±é€šä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«å‘¼ã³å‡ºã—
        const openSaveModal = async () => {
            autoTide = calculateTide();
            document.getElementById('save-modal').style.display = 'flex';
            autoAddr = await fetchLocation();
            const dispSize = (sizeDisplay.innerText === "--- cm") ? "æœªè¨ˆæ¸¬" : sizeDisplay.innerText;
            document.getElementById('auto-data-display').innerText = `ã‚µã‚¤ã‚º: ${dispSize}\næ½®ä½: ${autoTide}\nä½æ‰€: ${autoAddr}`;
        };

        savePanelBtn.addEventListener('click', openSaveModal);
        quickSaveBtn.addEventListener('click', openSaveModal);

        document.getElementById('final-save-btn').addEventListener('click', () => {
            const item = {
                id: Date.now(), img: currentImageRaw, size: sizeDisplay.innerText,
                fish: document.getElementById('fish-type').value || "è¨˜éŒ²", addr: autoAddr, tide: autoTide,
                memo: document.getElementById('memo-field').value, date: new Date().toLocaleString()
            };
            const h = JSON.parse(localStorage.getItem('fish_v10') || '[]');
            h.unshift(item); localStorage.setItem('fish_v10', JSON.stringify(h));
            alert('ä¿å­˜å®Œäº†ï¼');
            document.getElementById('save-modal').style.display = 'none';
            startCamera();
        });

        document.getElementById('close-save-btn').onclick = () => document.getElementById('save-modal').style.display = 'none';

        document.getElementById('album-btn').addEventListener('click', () => {
            const list = document.getElementById('album-list'); list.innerHTML = '';
            const h = JSON.parse(localStorage.getItem('fish_v10') || '[]');
            h.forEach(i => {
                const d = document.createElement('div'); d.className = 'album-item';
                const s = i.size === "--- cm" ? "ï¼ˆæœªè¨ˆæ¸¬ï¼‰" : i.size;
                d.innerHTML = `<img src="${i.img}" class="album-img"><div class="album-info"><div><b>${i.fish} ${s}</b><br>${i.tide}<br>${i.addr}</div><div style="display:flex;gap:4px;"><button style="flex:1;background:#555;padding:4px;font-size:10px;" onclick="downloadImg('${i.img}','${i.fish}')">ä¿å­˜</button><button style="flex:1;background:var(--danger);padding:4px;font-size:10px;" onclick="deleteItem(${i.id})">å‰Šé™¤</button></div></div>`;
                list.appendChild(d);
            });
            document.getElementById('album-view').style.display = 'flex';
        });

        document.getElementById('close-album-btn').onclick = () => document.getElementById('album-view').style.display = 'none';
        window.downloadImg = (url, name) => { const a = document.createElement('a'); a.href = url; a.download = `${name}.jpg`; a.click(); };
        window.deleteItem = (id) => { if(confirm('æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ let h = JSON.parse(localStorage.getItem('fish_v10')||'[]'); h = h.filter(x => x.id !== id); localStorage.setItem('fish_v10', JSON.stringify(h)); document.getElementById('album-btn').click(); } };

        function calculateTide() {
            const now = new Date(); const age = ((now - new Date(2026,0,19))/(1000*3600*24))%29.53;
            let n = "ä¸­æ½®"; if(age<2||age>=28||(age>=14&&age<16)) n="å¤§æ½®"; else if(age>=8&&age<10) n="é•·æ½®";
            const h = now.getHours()+(now.getMinutes()/60); const ph = Math.sin((h/12.42)*Math.PI*2);
            return `${n} ${Math.sin(((h+0.5)/12.42)*Math.PI*2)>ph?'ä¸Šã’':'ä¸‹ã’'}${Math.abs(Math.round(ph*10))}éƒ¨`;
        }
        async function fetchLocation() {
            return new Promise(r => {
                navigator.geolocation.getCurrentPosition(async p => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`, {headers:{'Accept-Language':'ja'}});
                        const d = await res.json(); 
                        r(d.display_name.split(',').reverse().join('').replace(/æ—¥æœ¬|ã€’?\s?\d{3}-?\d{4}/g, '').trim());
                    } catch(e) { r("ä½æ‰€ä¸æ˜"); }
                }, () => r("ä½ç½®æƒ…å ±ãªã—"));
            });
        }
    </script>
</body>
</html>
